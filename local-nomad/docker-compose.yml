services:
  nomad-server:
    build: .
    container_name: nomad-server
    network_mode: host
    privileged: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./nomad-server.hcl:/etc/nomad/nomad.hcl
      - ./register-jobs.sh:/usr/local/bin/register-jobs.sh
      - ../job_defs/local:/nomad/jobs
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - /tmp:/tmp
    environment:
      - NOMAD_ADDR=http://localhost:4646
    command: ["nomad", "agent", "-config", "/etc/nomad/nomad.hcl"]

  job-registrar:
    build: .
    container_name: nomad-job-registrar
    network_mode: host
    volumes:
      - ./register-jobs.sh:/usr/local/bin/register-jobs.sh
      - ../job_defs/local:/nomad/jobs
    environment:
      - NOMAD_ADDR=http://localhost:4646
    entrypoint: ["/bin/sh", "-c"]
    command: ["sleep 10 && /usr/local/bin/register-jobs.sh"]
    depends_on:
      - nomad-server
